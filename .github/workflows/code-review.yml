name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  review-with-tracking:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        
        with:
          fetch-depth: 1

      - name: Claude PR Review
        uses: anthropics/claude-code-action@v1

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # No need to change this, It is generated automatically by github for every workflow

        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }} # This is the secret or api key generated by anthropic, Whatever the env variable is saved with will be used here.
          track_progress: true

          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            Create a comprehensive review of the pr using the guidlines in file : .claude/agents/pr-reviewer.md
            Post Inline Comments as well where required, It is mandatory to post Inline Comments as well.
            Review isn't completed without posting inline commnets.
            
          claude_args: '--dangerously-skip-permissions --allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(gh api repos/*/pulls/*/reviews:*),Bash(gh api repos/*/pulls/*/comments:*),Bash(gh pr review:*)"'
 